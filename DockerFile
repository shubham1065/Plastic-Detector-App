# Use a base image with Python, which is necessary for PyTorch and FastAPI
FROM python:3.10-slim

# Set the working directory inside the container
WORKDIR /app

# --- Install Dependencies ---

# 1. Install system dependencies needed for libraries like Pillow (image processing)
RUN apt-get update && apt-get install -y \
    libsm6 \
    libxext6 \
    libxrender1 \
    && rm -rf /var/lib/apt/lists/*

# 2. Copy the requirements file and install dependencies (including PyTorch)
# We must use the specialized pip install command here to ensure PyTorch installs correctly.
COPY requirements.txt .

# Install PyTorch dependencies first from the CPU index, then the rest.
RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu && \
    pip install -r requirements.txt

# --- Copy Application Files ---

# Copy all files from your local directory into the container's /app folder
COPY . .

# --- Startup Command ---

# Expose the port (Hugging Face uses port 7860 by default)
EXPOSE 7860

# Command to run the application when the container starts.
# It uses the python entrypoint defined in your app.py file (if __name__ == "__main__":)
CMD ["python", "app.py"]
